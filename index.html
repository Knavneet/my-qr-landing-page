<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting Call...</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Fixed Azure Communication Services CDN links -->
    <script src="https://unpkg.com/@azure/communication-common@2.3.0/dist/browser/communication-common.js"></script>
    <script src="https://unpkg.com/@azure/communication-calling@1.24.1/dist/browser/communication-calling.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 20px;
            object-fit: cover;
            border: 3px solid #eee;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #111;
        }
        p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #555;
        }
        .button {
            display: inline-block;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.end-call {
            background-color: #dc3545;
        }
        .button.end-call:hover {
            background-color: #c82333;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #callStatus {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        .debug-info p {
            margin: 2px 0;
            font-size: 10px;
        }
        .sdk-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .sdk-loaded {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .sdk-failed {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .microphone-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="businessLogo" src="https://via.placeholder.com/80" alt="Business Logo" class="logo" style="display: none;">
        <h1 id="businessName">Loading...</h1>
        <p id="welcomeMessage">Please wait while we connect your call.</p>
        
        <div id="sdkStatus" class="sdk-status" style="display: none;"></div>
        <div id="microphoneStatus" class="microphone-status" style="display: none;"></div>
        
        <button id="callButton" class="button">Call Now</button>
        <button id="endCallButton" class="button end-call" style="display: none;">End Call</button>

        <div id="callStatus"></div>

        <div id="debugInfo" class="debug-info" style="display: none;">
            <h4>Debug Information:</h4>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vmxkrwqyxwfxbqvojypc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteGtyd3F5eHdmeGJxdm9qeXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNjA2MjUsImV4cCI6MjA2NDkzNjYyNX0.EH0wAMQJszlW1T8tL8VYIZ3BHBf8zVbu3sDhSwZbc04';
        
        // Initialize the Supabase client using the global 'supabase' from the CDN script
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const businessNameEl = document.getElementById('businessName');
        const welcomeMessageEl = document.getElementById('welcomeMessage');
        const businessLogoEl = document.getElementById('businessLogo');
        const callButton = document.getElementById('callButton');
        const endCallButton = document.getElementById('endCallButton');
        const callStatusDiv = document.getElementById('callStatus');
        const debugInfoDiv = document.getElementById('debugInfo');
        const sdkStatusDiv = document.getElementById('sdkStatus');
        const microphoneStatusDiv = document.getElementById('microphoneStatus');

        let qrPublicInfo = null;
        let callerAcsTokenData = null;
        let generatedCallId = null;

        // ACS SDK related variables
        let callClient;
        let callAgent;
        let deviceManager;
        let activeCall; 
        let sdksLoaded = false;

        function logDebug(message, data) {
            console.log(message, data || '');
            const p = document.createElement('p');
            p.textContent = `${new Date().toLocaleTimeString()}: ${message} ${data ? JSON.stringify(data) : ''}`;
            debugInfoDiv.appendChild(p);
            debugInfoDiv.scrollTop = debugInfoDiv.scrollHeight;
        }

        function updateSdkStatus(message, isError = false) {
            sdkStatusDiv.style.display = 'block';
            sdkStatusDiv.textContent = message;
            sdkStatusDiv.className = `sdk-status ${isError ? 'sdk-failed' : 'sdk-loaded'}`;
        }

        function updateMicrophoneStatus(message) {
            microphoneStatusDiv.style.display = 'block';
            microphoneStatusDiv.textContent = message;
        }

        function checkSdkAvailability() {
            logDebug('Checking SDK availability...');
            
            // Check for the Azure Communication Services global objects
            let foundSDKs = false;
            
            // Method 1: Check for UMD globals from unpkg
            if (window.AzureCommunicationCommon && window.AzureCommunicationCalling) {
                logDebug('Found UMD globals from unpkg');
                window.AzureCommunicationTokenCredential = window.AzureCommunicationCommon.AzureCommunicationTokenCredential;
                window.CallClient = window.AzureCommunicationCalling.CallClient;
                foundSDKs = true;
            }
            // Method 2: Check for direct global exports
            else if (window.AzureCommunicationTokenCredential && window.CallClient) {
                logDebug('Found direct global exports');
                foundSDKs = true;
            }
            // Method 3: Check for Azure namespace
            else if (window.Azure && window.Azure.Communication) {
                logDebug('Found Azure namespace');
                window.AzureCommunicationTokenCredential = window.Azure.Communication.Common?.AzureCommunicationTokenCredential;
                window.CallClient = window.Azure.Communication.Calling?.CallClient;
                foundSDKs = window.AzureCommunicationTokenCredential && window.CallClient;
            }
            
            logDebug('TokenCredential available:', typeof window.AzureCommunicationTokenCredential);
            logDebug('CallClient available:', typeof window.CallClient);
            
            if (foundSDKs && window.AzureCommunicationTokenCredential && window.CallClient) {
                sdksLoaded = true;
                updateSdkStatus('Azure Communication SDKs loaded successfully');
                return true;
            } else {
                const errorDetails = `TokenCredential: ${typeof window.AzureCommunicationTokenCredential}, CallClient: ${typeof window.CallClient}`;
                updateSdkStatus(`Azure Communication SDKs not loaded - ${errorDetails}`, true);
                return false;
            }
        }

        // Improved SDK loading with multiple CDN attempts
        async function loadSdksAlternative() {
            logDebug('Attempting alternative SDK loading...');
            
            const cdnSources = [
                {
                    name: 'unpkg with specific files',
                    scripts: [
                        'https://unpkg.com/@azure/communication-common@2.3.0/dist/browser/communication-common.min.js',
                        'https://unpkg.com/@azure/communication-calling@1.24.1/dist/browser/communication-calling.min.js'
                    ]
                },
                {
                    name: 'jsdelivr',
                    scripts: [
                        'https://cdn.jsdelivr.net/npm/@azure/communication-common@2.3.0/dist/browser/communication-common.min.js',
                        'https://cdn.jsdelivr.net/npm/@azure/communication-calling@1.24.1/dist/browser/communication-calling.min.js'
                    ]
                },
                {
                    name: 'unpkg alternative path',
                    scripts: [
                        'https://unpkg.com/@azure/communication-common@2.3.0/dist/index.browser.js',
                        'https://unpkg.com/@azure/communication-calling@1.24.1/dist/index.browser.js'
                    ]
                }
            ];
            
            for (const source of cdnSources) {
                try {
                    logDebug(`Trying ${source.name}...`);
                    
                    // Remove old script tags first
                    const oldScripts = document.querySelectorAll('script[src*="azure"]');
                    oldScripts.forEach(script => script.remove());
                    
                    for (const scriptUrl of source.scripts) {
                        await loadScript(scriptUrl);
                    }
                    
                    // Wait for scripts to initialize
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    if (checkSdkAvailability()) {
                        logDebug(`Successfully loaded SDKs from ${source.name}`);
                        return true;
                    }
                } catch (error) {
                    logDebug(`Failed to load from ${source.name}:`, error.message);
                    continue;
                }
            }
            
            return false;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    logDebug(`Successfully loaded: ${src}`);
                    resolve();
                };
                script.onerror = (error) => {
                    logDebug(`Failed to load: ${src}`, error);
                    reject(error);
                };
                document.head.appendChild(script);
            });
        }

        async function fetchQrPublicInfo(qrId) {
            logDebug('Fetching QR public info for ID:', qrId);
            const { data, error } = await supabaseClient.functions.invoke('get-qr-public-info', {
                body: { qr_code_id: qrId }
            });
            if (error) {
                logDebug('Error fetching QR public info:', error);
                throw new Error(error.message || `Failed to fetch QR info: ${error.details || 'Unknown error'}`);
            }
            if (data && data.error) {
                logDebug('API Error fetching QR public info:', data.error);
                throw new Error(data.error);
            }
            logDebug('QR public info fetched:', data);
            return data;
        }

        async function getCallerAcsToken() {
            logDebug('Fetching ACS token for web caller...');
            const { data, error } = await supabaseClient.functions.invoke('get-acs-token', {
                method: 'POST'
            });
            if (error) {
                logDebug('Error fetching caller ACS token:', error);
                throw new Error(error.message || `Failed to fetch caller ACS token: ${error.details || 'Unknown error'}`);
            }
            if (data && data.error) {
                 logDebug('API Error fetching caller ACS token:', data.error);
                throw new Error(data.error);
            }
            logDebug('Caller ACS token fetched.');
            return data;
        }
        
        // Function to initialize ACS SDK components
        async function initializeAcsSdk() {
            if (!callerAcsTokenData || !callerAcsTokenData.token) {
                const errorMessage = 'Error: Caller ACS token not available for SDK initialization.';
                callStatusDiv.textContent = errorMessage;
                callStatusDiv.className = 'error';
                logDebug(errorMessage);
                return false;
            }

            if (!sdksLoaded) {
                const sdkErrorMessage = 'Error: Azure Communication SDKs not loaded. Please refresh the page.';
                callStatusDiv.textContent = sdkErrorMessage;
                callStatusDiv.className = 'error';
                logDebug(sdkErrorMessage);
                return false;
            }

            try {
                logDebug('Initializing ACS CallClient...');
                callClient = new window.CallClient();
                const tokenCredential = new window.AzureCommunicationTokenCredential(callerAcsTokenData.token);
                
                logDebug('Creating CallAgent...');
                callAgent = await callClient.createCallAgent(tokenCredential, { displayName: 'Web Caller' });
                logDebug('CallAgent created.');
                
                deviceManager = await callClient.getDeviceManager(); 
                logDebug('DeviceManager obtained.');
                
                // Request microphone permissions
                try {
                    await deviceManager.askDevicePermission({ audio: true });
                    updateMicrophoneStatus('Microphone access granted');
                    logDebug('Microphone permissions granted');
                } catch (permError) {
                    updateMicrophoneStatus('Microphone access denied - call may not work properly');
                    logDebug('Microphone permission error:', permError);
                }
                
                callStatusDiv.textContent = 'Ready to call.';
                callStatusDiv.className = '';
                return true;
            } catch (error) {
                const errorMessage = `Error initializing ACS: ${error.message || error}`;
                logDebug('Failed to initialize ACS SDK:', error);
                callStatusDiv.textContent = errorMessage;
                callStatusDiv.className = 'error';
                return false;
            }
        }

        callButton.addEventListener('click', async () => {
            callButton.disabled = true;
            callStatusDiv.textContent = 'Processing...';
            callStatusDiv.className = '';

            try {
                // Check SDK availability first
                if (!sdksLoaded) {
                    throw new Error("Azure Communication SDKs are not loaded. Please refresh the page.");
                }

                // qrPublicInfo should be loaded by window.onload
                if (!qrPublicInfo) {
                    throw new Error("Business information not loaded yet. Please refresh.");
                }

                // 1. Get Caller ACS Token (for this web user)
                callerAcsTokenData = await getCallerAcsToken();
                if (!callerAcsTokenData || !callerAcsTokenData.acsUserId || !callerAcsTokenData.token) {
                    throw new Error('Failed to obtain a token for the web caller.');
                }
                logDebug('Caller ACS User ID:', callerAcsTokenData.acsUserId);
                logDebug('Caller Token Expires:', callerAcsTokenData.expiresOn);

                // 2. Generate a unique Call ID (UUID)
                generatedCallId = self.crypto.randomUUID();
                logDebug('Generated Call ID:', generatedCallId);

                // 3. Initialize ACS SDK for the web caller
                const acsInitialized = await initializeAcsSdk();
                if (!acsInitialized) {
                    callButton.disabled = false;
                    return;
                }

                // 4. Call 'initiate-call-and-notify' Supabase function
                callStatusDiv.textContent = 'Notifying owner...';
                logDebug('Calling initiate-call-and-notify function with:', {
                    callerAcsId: callerAcsTokenData.acsUserId,
                    ownerAcsId: qrPublicInfo.ownerAcsUserId,
                    qrCodeId: qrPublicInfo.qrCodeId,
                    callId: generatedCallId,
                    callerName: "Web Caller via " + (qrPublicInfo.name || "QR Code")
                });

                const { data: notifyData, error: notifyError } = await supabaseClient.functions.invoke(
                    'initiate-call-and-notify',
                    {
                        body: {
                            callerAcsId: callerAcsTokenData.acsUserId,
                            ownerAcsId: qrPublicInfo.ownerAcsUserId,
                            qrCodeId: qrPublicInfo.qrCodeId,
                            callId: generatedCallId,
                            callerName: "Web Caller via " + (qrPublicInfo.name || "QR Code")
                        }
                    }
                );

                if (notifyError) {
                    logDebug('Notify function error:', notifyError);
                    throw new Error(notifyError.message || `Notification failed: ${notifyError.details || 'Unknown error'}`);
                }
                logDebug('Notification sent response:', notifyData);
                
                if (notifyData && notifyData.error && notifyData.error.includes("offline")) {
                    callStatusDiv.textContent = `Owner is offline. Please try later.`;
                    callStatusDiv.className = 'error';
                    callButton.disabled = false;
                    return;
                }
                if (notifyData && notifyData.error) {
                    throw new Error(notifyData.error);
                }

                callStatusDiv.textContent = 'Owner notified. Attempting to start call...';

                // 5. Start the ACS call from the web
                if (!callAgent) {
                    throw new Error('Call Agent not initialized.');
                }
                if (!qrPublicInfo || !qrPublicInfo.ownerAcsUserId) {
                    throw new Error('Owner ACS ID not available.');
                }

                logDebug(`Starting ACS call to ${qrPublicInfo.ownerAcsUserId} with callId ${generatedCallId}`);
                const callOptions = {
                    audioOptions: { muted: false }
                };
                
                activeCall = callAgent.startCall(
                    [{ communicationUserId: qrPublicInfo.ownerAcsUserId }],
                    callOptions
                );
                
                logDebug('ACS Call object created:', activeCall ? activeCall.id : 'null');
                callStatusDiv.textContent = 'Ringing...';
                endCallButton.style.display = 'block';
                callButton.style.display = 'none';

                // Handle call state changes
                activeCall.on('stateChanged', () => {
                    logDebug(`Call state changed: ${activeCall.state}`);
                    const stateMessages = {
                        'None': 'Initializing...',
                        'Connecting': 'Connecting...',
                        'Ringing': 'Ringing...',
                        'Connected': 'Connected! You can now talk.',
                        'LocalHold': 'Call on hold',
                        'RemoteHold': 'Call on hold by other party',
                        'InLobby': 'In lobby...',
                        'Disconnecting': 'Disconnecting...',
                        'Disconnected': 'Call ended'
                    };
                    
                    const message = stateMessages[activeCall.state] || `Call state: ${activeCall.state}`;
                    callStatusDiv.textContent = message;
                    
                    if (activeCall.state === 'Connected') {
                        callStatusDiv.className = '';
                    } else if (activeCall.state === 'Disconnected') {
                        callStatusDiv.className = '';
                        endCallButton.style.display = 'none';
                        callButton.style.display = 'block';
                        callButton.disabled = false;
                        activeCall = null;
                    }
                });

                activeCall.on('idChanged', () => {
                    logDebug(`Call ID changed: ${activeCall.id}`);
                });

                // Handle remote participants
                activeCall.on('remoteParticipantsUpdated', (e) => {
                    logDebug('Remote participants updated:', e);
                    e.added.forEach(participant => {
                        logDebug('Participant added:', participant.identifier);
                    });
                    e.removed.forEach(participant => {
                        logDebug('Participant removed:', participant.identifier);
                    });
                });

            } catch (error) {
                logDebug('Error during call process:', error);
                callStatusDiv.textContent = `Error: ${error.message || error}`;
                callStatusDiv.className = 'error';
                callButton.disabled = false;
            }
        });

        // Event listener for the "End Call" button
        endCallButton.addEventListener('click', async () => {
            if (activeCall) {
                try {
                    logDebug('Ending call...');
                    await activeCall.hangUp({ forEveryone: false });
                    callStatusDiv.textContent = 'Call ended.';
                } catch (error) {
                    logDebug('Error ending call:', error);
                    callStatusDiv.textContent = `Error ending call: ${error.message || error}`;
                    callStatusDiv.className = 'error';
                } finally {
                    endCallButton.style.display = 'none';
                    callButton.style.display = 'block';
                    callButton.disabled = false;
                    activeCall = null;
                }
            }
        });

        // Wait for scripts to load before proceeding
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const qrId = params.get('qr_id');
            debugInfoDiv.style.display = 'block';

            // Check SDK availability after page load with multiple attempts
            let attempts = 0;
            const maxAttempts = 3;
            const checkInterval = 2000; // Increased interval
            
            const checkSdksRepeatedly = async () => {
                attempts++;
                logDebug(`SDK check attempt ${attempts}/${maxAttempts}`);
                
                sdksLoaded = checkSdkAvailability();
                
                if (!sdksLoaded && attempts < maxAttempts) {
                    setTimeout(checkSdksRepeatedly, checkInterval);
                } else if (!sdksLoaded) {
                    // Try alternative loading method
                    logDebug('Trying alternative SDK loading methods...');
                    sdksLoaded = await loadSdksAlternative();
                    
                    if (!sdksLoaded) {
                        callButton.disabled = true;
                        callStatusDiv.textContent = 'SDKs failed to load. This may be due to network issues or browser restrictions.';
                        callStatusDiv.className = 'error';
                        
                        // Provide detailed fallback suggestions
                        const fallbackMsg = document.createElement('div');
                        fallbackMsg.innerHTML = `
                            <p style="margin-top: 15px; font-size: 12px; color: #666;">
                                <strong>Troubleshooting steps:</strong><br>
                                1. Refresh the page and try again<br>
                                2. Check your internet connection<br>
                                3. Disable ad blockers or tracking protection<br>
                                4. Try a different browser (Chrome, Edge, Firefox)<br>
                                5. Clear browser cache and cookies<br>
                                6. Check if browser extensions are blocking scripts
                            </p>
                        `;
                        callStatusDiv.appendChild(fallbackMsg);
                    }
                }
            };
            
            // Start checking after a longer delay to allow scripts to fully load
            setTimeout(checkSdksRepeatedly, 3000);

            if (!qrId) {
                businessNameEl.textContent = 'Error';
                welcomeMessageEl.textContent = 'QR Code ID not found in URL.';
                callButton.disabled = true;
                logDebug('QR ID missing from URL.');
                return;
            }

            try {
                qrPublicInfo = await fetchQrPublicInfo(qrId);
                
                if (qrPublicInfo.status && qrPublicInfo.status !== 'online') {
                     businessNameEl.textContent = qrPublicInfo.name || 'Business';
                     welcomeMessageEl.textContent = `Sorry, ${qrPublicInfo.ownerName || 'the owner'} is currently ${qrPublicInfo.status}. Please try again later.`;
                     callButton.disabled = true;
                     callButton.textContent = 'Owner Offline';
                     logDebug(`Owner status: ${qrPublicInfo.status}`);
                     return;
                }

                businessNameEl.textContent = qrPublicInfo.name || 'Business';
                welcomeMessageEl.textContent = qrPublicInfo.welcomeMessage || 'Welcome!';
                if (qrPublicInfo.logoUrl) {
                    businessLogoEl.src = qrPublicInfo.logoUrl;
                    businessLogoEl.style.display = 'block';
                }
                
                // Apply branding color
                const brandingColor = qrPublicInfo.brandingColor || '#007bff';
                callButton.style.backgroundColor = brandingColor;
                
                // Update CSS custom property for hover states
                const style = document.createElement('style');
                style.textContent = `
                    .button:hover {
                        background-color: ${brandingColor}dd !important;
                    }
                `;
                document.head.appendChild(style);
                
                // Only enable call button if SDKs are loaded
                const enableButtonWhenReady = () => {
                    if (sdksLoaded) {
                        callButton.disabled = false;
                        callButton.textContent = 'Call Now';
                    } else {
                        // Check again in a bit
                        setTimeout(enableButtonWhenReady, 1000);
                    }
                };
                enableButtonWhenReady();

                logDebug('Page loaded. QR Info:', qrPublicInfo);

            } catch (error) {
                businessNameEl.textContent = 'Error';
                welcomeMessageEl.textContent = error.message || 'Could not load QR information.';
                callButton.disabled = true;
                logDebug('Error on page load:', error);
            }
        });
    </script>
</body>
</html>
