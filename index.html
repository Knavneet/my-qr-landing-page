<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting Call...</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Try alternative CDN sources for Azure Communication Services -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/communication-common@2.3.0/dist/browser/azure-communication-common.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@azure/communication-calling@1.24.1/dist/browser/azure-communication-calling.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 20px;
            object-fit: cover;
            border: 3px solid #eee;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #111;
        }
        p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #555;
        }
        .button {
            display: inline-block;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.end-call {
            background-color: #dc3545;
        }
        .button.end-call:hover {
            background-color: #c82333;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #callStatus {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        .debug-info p {
            margin: 2px 0;
            font-size: 10px;
        }
        .sdk-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .sdk-loaded {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .sdk-failed {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="businessLogo" src="https://via.placeholder.com/80" alt="Business Logo" class="logo" style="display: none;">
        <h1 id="businessName">Loading...</h1>
        <p id="welcomeMessage">Please wait while we connect your call.</p>
        
        <div id="sdkStatus" class="sdk-status" style="display: none;"></div>
        
        <button id="callButton" class="button">Call Now</button>
        <button id="endCallButton" class="button end-call" style="display: none;">End Call</button>

        <div id="callStatus"></div>

        <div id="debugInfo" class="debug-info" style="display: none;">
            <h4>Debug Information:</h4>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vmxkrwqyxwfxbqvojypc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteGtyd3F5eHdmeGJxdm9qeXBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNjA2MjUsImV4cCI6MjA2NDkzNjYyNX0.EH0wAMQJszlW1T8tL8VYIZ3BHBf8zVbu3sDhSwZbc04';
        
        // Initialize the Supabase client using the global 'supabase' from the CDN script
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const businessNameEl = document.getElementById('businessName');
        const welcomeMessageEl = document.getElementById('welcomeMessage');
        const businessLogoEl = document.getElementById('businessLogo');
        const callButton = document.getElementById('callButton');
        const endCallButton = document.getElementById('endCallButton');
        const callStatusDiv = document.getElementById('callStatus');
        const debugInfoDiv = document.getElementById('debugInfo');
        const sdkStatusDiv = document.getElementById('sdkStatus');

        let qrPublicInfo = null;
        let callerAcsTokenData = null;
        let generatedCallId = null;

        // ACS SDK related variables
        let callClient;
        let callAgent;
        let deviceManager;
        let activeCall; 
        let sdksLoaded = false;

        function logDebug(message, data) {
            console.log(message, data || '');
            const p = document.createElement('p');
            p.textContent = `${new Date().toLocaleTimeString()}: ${message} ${data ? JSON.stringify(data) : ''}`;
            debugInfoDiv.appendChild(p);
            debugInfoDiv.scrollTop = debugInfoDiv.scrollHeight;
        }

        function updateSdkStatus(message, isError = false) {
            sdkStatusDiv.style.display = 'block';
            sdkStatusDiv.textContent = message;
            sdkStatusDiv.className = `sdk-status ${isError ? 'sdk-failed' : 'sdk-loaded'}`;
        }

        function checkSdkAvailability() {
            logDebug('Checking SDK availability...');
            
            // Log all available properties on window to debug
            const windowKeys = Object.keys(window).filter(key => key.toLowerCase().includes('azure') || key.toLowerCase().includes('communication') || key.toLowerCase().includes('call'));
            logDebug('Window properties with azure/communication/call:', windowKeys);
            
            // Check various possible global names
            const possibleNames = [
                'AzureCommunicationTokenCredential',
                'CallClient',
                'AzureCommunicationCommon',
                'AzureCommunicationCalling'
            ];
            
            let foundObjects = {};
            possibleNames.forEach(name => {
                foundObjects[name] = typeof window[name] !== 'undefined';
                logDebug(`${name} available:`, foundObjects[name]);
            });
            
            // Try to find the actual constructors
            let TokenCredential, CallClientConstructor;
            
            // Check if they're nested in namespace objects
            if (window.AzureCommunicationCommon) {
                TokenCredential = window.AzureCommunicationCommon.AzureCommunicationTokenCredential;
                logDebug('Found TokenCredential in AzureCommunicationCommon namespace');
            } else {
                TokenCredential = window.AzureCommunicationTokenCredential;
            }
            
            if (window.AzureCommunicationCalling) {
                CallClientConstructor = window.AzureCommunicationCalling.CallClient;
                logDebug('Found CallClient in AzureCommunicationCalling namespace');
            } else {
                CallClientConstructor = window.CallClient;
            }
            
            logDebug('Final TokenCredential check:', typeof TokenCredential !== 'undefined');
            logDebug('Final CallClient check:', typeof CallClientConstructor !== 'undefined');
            
            if (TokenCredential && CallClientConstructor) {
                // Store references for later use
                window.AzureCommunicationTokenCredential = TokenCredential;
                window.CallClient = CallClientConstructor;
                sdksLoaded = true;
                updateSdkStatus('Azure Communication SDKs loaded successfully');
                return true;
            } else {
                updateSdkStatus('Azure Communication SDKs failed to load - constructors not found', true);
                return false;
            }
        }

        async function fetchQrPublicInfo(qrId) {
            logDebug('Fetching QR public info for ID:', qrId);
            const { data, error } = await supabaseClient.functions.invoke('get-qr-public-info', {
                body: { qr_code_id: qrId }
            });
            if (error) {
                logDebug('Error fetching QR public info:', error);
                throw new Error(error.message || `Failed to fetch QR info: ${error.details || 'Unknown error'}`);
            }
            if (data && data.error) {
                logDebug('API Error fetching QR public info:', data.error);
                throw new Error(data.error);
            }
            logDebug('QR public info fetched:', data);
            return data;
        }

        async function getCallerAcsToken() {
            logDebug('Fetching ACS token for web caller...');
            const { data, error } = await supabaseClient.functions.invoke('get-acs-token', {
                method: 'POST'
            });
            if (error) {
                logDebug('Error fetching caller ACS token:', error);
                throw new Error(error.message || `Failed to fetch caller ACS token: ${error.details || 'Unknown error'}`);
            }
            if (data && data.error) {
                 logDebug('API Error fetching caller ACS token:', data.error);
                throw new Error(data.error);
            }
            logDebug('Caller ACS token fetched.');
            return data;
        }
        
        // Function to initialize ACS SDK components
        async function initializeAcsSdk() {
            if (!callerAcsTokenData || !callerAcsTokenData.token) {
                const errorMessage = 'Error: Caller ACS token not available for SDK initialization.';
                callStatusDiv.textContent = errorMessage;
                callStatusDiv.className = 'error';
                logDebug(errorMessage);
                return false;
            }

            if (!sdksLoaded) {
                const sdkErrorMessage = 'Error: Azure Communication SDKs not loaded. Please refresh the page.';
                callStatusDiv.textContent = sdkErrorMessage;
                callStatusDiv.className = 'error';
                logDebug(sdkErrorMessage);
                return false;
            }

            try {
                logDebug('Initializing ACS CallClient...');
                callClient = new window.CallClient();
                const tokenCredential = new window.AzureCommunicationTokenCredential(callerAcsTokenData.token);
                
                logDebug('Creating CallAgent...');
                callAgent = await callClient.createCallAgent(tokenCredential, { displayName: 'Web Caller' });
                logDebug('CallAgent created.');
                
                deviceManager = await callClient.getDeviceManager(); 
                logDebug('DeviceManager obtained.');
                
                callStatusDiv.textContent = 'Ready to call.';
                callStatusDiv.className = '';
                return true;
            } catch (error) {
                const errorMessage = `Error initializing ACS: ${error.message || error}`;
                logDebug('Failed to initialize ACS SDK:', error);
                callStatusDiv.textContent = errorMessage;
                callStatusDiv.className = 'error';
                return false;
            }
        }

        callButton.addEventListener('click', async () => {
            callButton.disabled = true;
            callStatusDiv.textContent = 'Processing...';
            callStatusDiv.className = '';

            try {
                // Check SDK availability first
                if (!sdksLoaded) {
                    throw new Error("Azure Communication SDKs are not loaded. Please refresh the page.");
                }

                // qrPublicInfo should be loaded by window.onload
                if (!qrPublicInfo) {
                    throw new Error("Business information not loaded yet. Please refresh.");
                }

                // 1. Get Caller ACS Token (for this web user)
                callerAcsTokenData = await getCallerAcsToken();
                if (!callerAcsTokenData || !callerAcsTokenData.acsUserId || !callerAcsTokenData.token) {
                    throw new Error('Failed to obtain a token for the web caller.');
                }
                logDebug('Caller ACS User ID:', callerAcsTokenData.acsUserId);
                logDebug('Caller Token Expires:', callerAcsTokenData.expiresOn);

                // 2. Generate a unique Call ID (UUID)
                generatedCallId = self.crypto.randomUUID();
                logDebug('Generated Call ID:', generatedCallId);

                // 3. Initialize ACS SDK for the web caller
                const acsInitialized = await initializeAcsSdk();
                if (!acsInitialized) {
                    callButton.disabled = false;
                    return;
                }

                // 4. Call 'initiate-call-and-notify' Supabase function
                callStatusDiv.textContent = 'Notifying owner...';
                logDebug('Calling initiate-call-and-notify function with:', {
                    callerAcsId: callerAcsTokenData.acsUserId,
                    ownerAcsId: qrPublicInfo.ownerAcsUserId,
                    qrCodeId: qrPublicInfo.qrCodeId,
                    callId: generatedCallId,
                    callerName: "Web Caller via " + (qrPublicInfo.name || "QR Code")
                });

                const { data: notifyData, error: notifyError } = await supabaseClient.functions.invoke(
                    'initiate-call-and-notify',
                    {
                        body: {
                            callerAcsId: callerAcsTokenData.acsUserId,
                            ownerAcsId: qrPublicInfo.ownerAcsUserId,
                            qrCodeId: qrPublicInfo.qrCodeId,
                            callId: generatedCallId,
                            callerName: "Web Caller via " + (qrPublicInfo.name || "QR Code")
                        }
                    }
                );

                if (notifyError) {
                    logDebug('Notify function error:', notifyError);
                    throw new Error(notifyError.message || `Notification failed: ${notifyError.details || 'Unknown error'}`);
                }
                logDebug('Notification sent response:', notifyData);
                
                if (notifyData && notifyData.error && notifyData.error.includes("offline")) {
                    callStatusDiv.textContent = `Owner is offline. Please try later.`;
                    callStatusDiv.className = 'error';
                    callButton.disabled = false;
                    return;
                }
                if (notifyData && notifyData.error) {
                    throw new Error(notifyData.error);
                }

                callStatusDiv.textContent = 'Owner notified. Attempting to start call...';

                // 5. Start the ACS call from the web
                if (!callAgent) {
                    throw new Error('Call Agent not initialized.');
                }
                if (!qrPublicInfo || !qrPublicInfo.ownerAcsUserId) {
                    throw new Error('Owner ACS ID not available.');
                }

                logDebug(`Starting ACS call to ${qrPublicInfo.ownerAcsUserId} with callId ${generatedCallId}`);
                const callOptions = {
                    audioOptions: { muted: false },
                    callId: generatedCallId
                };
                
                activeCall = callAgent.startCall(
                    [{ communicationUserId: qrPublicInfo.ownerAcsUserId }],
                    callOptions
                );
                
                logDebug('ACS Call object created:', activeCall ? activeCall.id : 'null');
                callStatusDiv.textContent = 'Ringing...';
                endCallButton.style.display = 'block';
                callButton.style.display = 'none';

                // Handle call state changes
                activeCall.on('stateChanged', () => {
                    logDebug(`Call state changed: ${activeCall.state}`);
                    callStatusDiv.textContent = `Call state: ${activeCall.state}`;
                    if (activeCall.state === 'Connected') {
                        callStatusDiv.textContent = 'Connected!';
                    }
                    if (activeCall.state === 'Disconnected') {
                        callStatusDiv.textContent = 'Call Disconnected.';
                        endCallButton.style.display = 'none';
                        callButton.style.display = 'block';
                        callButton.disabled = false;
                        activeCall = null;
                    }
                });

                activeCall.on('idChanged', () => {
                    logDebug(`Call ID changed: ${activeCall.id}`);
                });

            } catch (error) {
                logDebug('Error during call process:', error);
                callStatusDiv.textContent = `Error: ${error.message || error}`;
                callStatusDiv.className = 'error';
                callButton.disabled = false;
            }
        });

        // Event listener for the "End Call" button
        endCallButton.addEventListener('click', async () => {
            if (activeCall) {
                try {
                    logDebug('Ending call...');
                    await activeCall.hangUp({ forEveryone: true });
                } catch (error) {
                    logDebug('Error ending call:', error);
                    callStatusDiv.textContent = `Error ending call: ${error.message || error}`;
                    callStatusDiv.className = 'error';
                    endCallButton.style.display = 'none';
                    callButton.style.display = 'block';
                    callButton.disabled = false;
                    activeCall = null;
                }
            }
        });

        // Wait for scripts to load before proceeding
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const qrId = params.get('qr_id');
            debugInfoDiv.style.display = 'block';

            // Check SDK availability after page load with multiple attempts
            let attempts = 0;
            const maxAttempts = 5;
            const checkInterval = 1000;
            
            const checkSdksRepeatedly = () => {
                attempts++;
                logDebug(`SDK check attempt ${attempts}/${maxAttempts}`);
                
                sdksLoaded = checkSdkAvailability();
                
                if (!sdksLoaded && attempts < maxAttempts) {
                    setTimeout(checkSdksRepeatedly, checkInterval);
                } else if (!sdksLoaded) {
                    callButton.disabled = true;
                    callStatusDiv.textContent = 'SDKs failed to load after multiple attempts. Please refresh the page or check your internet connection.';
                    callStatusDiv.className = 'error';
                    
                    // Provide fallback suggestion
                    const fallbackMsg = document.createElement('p');
                    fallbackMsg.innerHTML = 'Try: <br>1. Refresh the page<br>2. Check your internet connection<br>3. Disable ad blockers temporarily';
                    fallbackMsg.style.fontSize = '12px';
                    fallbackMsg.style.color = '#666';
                    fallbackMsg.style.marginTop = '10px';
                    callStatusDiv.appendChild(fallbackMsg);
                }
            };
            
            // Start checking after a short delay
            setTimeout(checkSdksRepeatedly, 500);

            if (!qrId) {
                businessNameEl.textContent = 'Error';
                welcomeMessageEl.textContent = 'QR Code ID not found in URL.';
                callButton.disabled = true;
                logDebug('QR ID missing from URL.');
                return;
            }

            try {
                qrPublicInfo = await fetchQrPublicInfo(qrId);
                
                if (qrPublicInfo.status && qrPublicInfo.status !== 'online') {
                     businessNameEl.textContent = qrPublicInfo.name || 'Business';
                     welcomeMessageEl.textContent = `Sorry, ${qrPublicInfo.ownerName || 'the owner'} is currently ${qrPublicInfo.status}. Please try again later.`;
                     callButton.disabled = true;
                     callButton.textContent = 'Owner Offline';
                     logDebug(`Owner status: ${qrPublicInfo.status}`);
                     return;
                }

                businessNameEl.textContent = qrPublicInfo.name || 'Business';
                welcomeMessageEl.textContent = qrPublicInfo.welcomeMessage || 'Welcome!';
                if (qrPublicInfo.logoUrl) {
                    businessLogoEl.src = qrPublicInfo.logoUrl;
                    businessLogoEl.style.display = 'block';
                }
                document.body.style.setProperty('--theme-color', qrPublicInfo.brandingColor || '#007bff');
                callButton.style.backgroundColor = qrPublicInfo.brandingColor || '#007bff';
                
                // Only enable call button if SDKs are loaded
                const enableButtonWhenReady = () => {
                    if (sdksLoaded) {
                        callButton.disabled = false;
                    } else {
                        // Check again in a bit
                        setTimeout(enableButtonWhenReady, 500);
                    }
                };
                enableButtonWhenReady();

                logDebug('Page loaded. QR Info:', qrPublicInfo);

            } catch (error) {
                businessNameEl.textContent = 'Error';
                welcomeMessageEl.textContent = error.message || 'Could not load QR information.';
                callButton.disabled = true;
                logDebug('Error on page load:', error);
            }
        });
    </script>
</body>
</html>
